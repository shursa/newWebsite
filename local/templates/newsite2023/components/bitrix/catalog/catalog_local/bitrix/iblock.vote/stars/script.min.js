(function(a){if(a.JCIblockVoteStars){return}a.JCIblockVoteStars=function(b){this.progressObj=null;this.ratingObj=null;this.starsObj=null;this.progressId="";this.ratingId="";this.starsId="";this.ajaxParams={};this.siteId="";this.voteData={element:0,percent:0,count:0};this.config={readOnly:false,alreadyVoted:true,request:false};if(BX.type.isPlainObject(b)){if(BX.type.isNotEmptyString(b.progressId)){this.progressId=b.progressId}if(BX.type.isNotEmptyString(b.ratingId)){this.ratingId=b.ratingId}if(BX.type.isNotEmptyString(b.starsId)){this.starsId=b.starsId}if(BX.type.isNotEmptyString(b.ajaxUrl)){this.ajaxUrl=b.ajaxUrl}if(BX.type.isNotEmptyString(b.checkVoteUrl)){this.checkVoteUrl=b.checkVoteUrl}if(BX.type.isPlainObject(b.ajaxParams)){this.ajaxParams=b.ajaxParams}if(BX.type.isNotEmptyString(b.siteId)){this.siteId=b.siteId}if(BX.type.isPlainObject(b.voteData)){if(BX.type.isNumber(b.voteData.element)){this.voteData.element=b.voteData.element}if(BX.type.isNumber(b.voteData.percent)){this.voteData.percent=this.preparePercent(b.voteData.percent)}if(BX.type.isNumber(b.voteData.count)){this.voteData.count=b.voteData.count}}if(BX.type.isBoolean(b.readOnly)){this.config.readOnly=b.readOnly}}BX.ready(BX.proxy(this.init,this))};a.JCIblockVoteStars.prototype.init=function(){if(BX.type.isNotEmptyString(this.progressId)){this.progressObj=BX(this.progressId)}if(BX.type.isNotEmptyString(this.ratingId)){this.ratingObj=BX(this.ratingId)}if(BX.type.isNotEmptyString(this.starsId)){this.starsObj=BX(this.starsId)}this.showProgress(this.voteData.percent);this.showVotes();this.checkVote()};a.JCIblockVoteStars.prototype.checkVote=function(){if(this.config.readOnly||this.voteData.element<=0){return}BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.checkVoteUrl,data:{sessid:BX.bitrix_sessid(),checkVote:"Y",vote_id:this.voteData.element,site_id:this.siteId},onsuccess:BX.proxy(this.checkVoteResult,this)})};a.JCIblockVoteStars.prototype.checkVoteResult=function(b){if(BX.type.isPlainObject(b)){if(b.success){this.config.alreadyVoted=b.voted}}if(this.config.readOnly||this.config.alreadyVoted||this.voteData.element<=0){return}if(BX.type.isElementNode(this.starsObj)){BX.bind(this.starsObj,"mousemove",BX.proxy(this.handlerMouseMove,this));BX.bind(this.starsObj,"mouseout",BX.proxy(this.handlerMouseOut,this));BX.bind(this.starsObj,"click",BX.proxy(this.handlerClick,this))}};a.JCIblockVoteStars.prototype.destroy=function(){if(BX.type.isElementNode(this.progressObj)){BX.unbindAll(this.progressObj)}this.progressObj=null;if(BX.type.isElementNode(this.ratingObj)){BX.unbindAll(this.ratingObj)}this.ratingObj=null;if(BX.type.isElementNode(this.starsObj)){BX.unbindAll(this.starsObj)}this.starsObj=null};a.JCIblockVoteStars.prototype.preparePercent=function(b){b=parseInt(b,10);if(isNaN(b)){b=0}else{if(b>100){b=100}else{if(b<0){b=0}}}return b};a.JCIblockVoteStars.prototype.showProgress=function(b){if(!BX.type.isElementNode(this.progressObj)){return}BX.style(this.progressObj,"width",b.toString()+"%")};a.JCIblockVoteStars.prototype.showVotes=function(){if(!BX.type.isElementNode(this.ratingObj)){return}this.ratingObj.innerHTML="( "+this.voteData.count+" )"};a.JCIblockVoteStars.prototype.handlerMouseMove=function(d){var c,b;if(this.config.readOnly||this.config.alreadyVoted||this.config.request){return}d=d||a.event;if(!BX.type.isElementNode(this.starsObj)){return}c=BX.pos(this.starsObj);b=((d.pageX-c.left)/c.width)*5;this.showProgress(this.preparePercent(Math.ceil(b)*20))};a.JCIblockVoteStars.prototype.handlerMouseOut=function(){if(this.config.readOnly||this.config.alreadyVoted||this.config.request){return}this.showProgress(this.voteData.percent)};a.JCIblockVoteStars.prototype.handlerClick=function(d){var b,c;if(this.config.readOnly||this.config.alreadyVoted||this.config.request){return}this.config.request=true;d=d||a.event;if(!BX.type.isElementNode(this.starsObj)){return}b=BX.pos(this.starsObj);c=parseInt(Math.ceil(((d.pageX-b.left)/b.width)*5),10);if(isNaN(c)){return}this.ajaxParams.rating=c-1;this.ajaxParams.vote="Y";this.ajaxParams.vote_id=this.voteData.element;this.ajaxParams.sessid=BX.bitrix_sessid();this.ajaxParams.site_id=this.siteId;BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:this.ajaxParams,onsuccess:BX.proxy(this.clickResult,this)})};a.JCIblockVoteStars.prototype.clickResult=function(b){this.config.request=false;if(BX.type.isPlainObject(b)){this.config.alreadyVoted=true;this.voteData.percent=this.preparePercent((b.value)*20);this.voteData.count=b.votes;this.showProgress(this.voteData.percent);this.showVotes()}}})(window);